# 1 Overview

## 1.1 Diagram Id

SEQ-UJ-002

## 1.2 Name

Admin Previews a Script with Sample Data

## 1.3 Description

An administrator tests a transformation script by providing sample JSON data directly in the UI. The script and sample data are sent to a dedicated preview endpoint, executed in a secure Jint sandbox with a strict timeout, and the result or a structured error is returned to the UI for display.

## 1.4 Type

üîπ UserJourney

## 1.5 Purpose

To allow for rapid, iterative development and testing of transformation scripts without needing live data.

## 1.6 Complexity

Medium

## 1.7 Priority

üî¥ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- REPO-APP-UI-005
- REPO-APP-API-001
- REPO-LIB-JINT-002

## 1.10 Key Interactions

- Admin inputs script and sample JSON, then clicks 'Preview'.
- UI sends POST to `/api/v1/transformations/preview` with script and `sampleData`.
- API controller creates a `CancellationTokenSource` with a configured 30-second delay.
- Controller calls `ScriptExecutionService.ExecutePreviewAsync`, passing the CancellationToken.
- Service invokes the `JintEngineWrapper.ExecuteAsync` with the script and data.
- Jint Engine executes the script within the secure sandbox (memory, statement limits).
- The transformed JSON output is returned to the API controller.
- API controller sends a 200 OK response with the transformed JSON to the UI.

## 1.11 Triggers

- Administrator clicks the 'Preview' button in the script editor UI.

## 1.12 Outcomes

- The transformed JSON output is displayed in the UI's output pane.
- If an error occurs, a structured error message is displayed instead.

## 1.13 Business Rules

- Preview execution must have a server-side timeout, enforced by a CancellationToken (REQ-DTR-005).
- Script execution must occur within a secure sandbox (REQ-DTR-001).

## 1.14 Error Scenarios

- The `CancellationToken` is triggered, causing a `TaskCanceledException` which is caught and returned as a timeout error.
- Script contains a syntax or runtime error, API returns a 400 Bad Request with a structured error object (REQ-DTR-006).
- Script violates a sandbox constraint (e.g., memory), triggering a security log and returning a 500 error.

## 1.15 Integration Points

- Control Panel UI (React)

# 2.0 Details

## 2.1 Diagram Id

SEQ-UJ-002-IMPL

## 2.2 Name

Implementation: Admin Previews Script with Sample Data

## 2.3 Description

Technical sequence for an administrator providing a script and sample JSON data to the preview endpoint. The diagram details the full request lifecycle including UI state management, API request/response flow, server-side timeout enforcement via CancellationToken, and secure script execution within the Jint sandbox. It also specifies the handling of success, timeout, script error, and sandbox violation scenarios.

## 2.4 Participants

### 2.4.1 React Single-Page Application

#### 2.4.1.1 Repository Id

REPO-APP-UI-005

#### 2.4.1.2 Display Name

Control Panel UI

#### 2.4.1.3 Type

üîπ React Single-Page Application

#### 2.4.1.4 Technology

React 18, TypeScript, Axios

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #3498DB |
| Stereotype | User Interface |

### 2.4.2.0 Web API Controller/Service

#### 2.4.2.1 Repository Id

REPO-APP-API-001

#### 2.4.2.2 Display Name

Transformation API

#### 2.4.2.3 Type

üîπ Web API Controller/Service

#### 2.4.2.4 Technology

ASP.NET Core 8

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #2ECC71 |
| Stereotype | API Gateway / Application Service |

### 2.4.3.0 Infrastructure Library

#### 2.4.3.1 Repository Id

REPO-LIB-JINT-002

#### 2.4.3.2 Display Name

Jint Engine Wrapper

#### 2.4.3.3 Type

üîπ Infrastructure Library

#### 2.4.3.4 Technology

.NET 8, Jint 3.x

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #F1C40F |
| Stereotype | Infrastructure |

## 2.5.0.0 Interactions

### 2.5.1.0 UI State Transition

#### 2.5.1.1 Source Id

REPO-APP-UI-005

#### 2.5.1.2 Target Id

REPO-APP-UI-005

#### 2.5.1.3 Message

User clicks 'Preview'. UI validates inputs (script and JSON not empty), sets state to 'loading', and displays a spinner.

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ UI State Transition

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | React State Management |
| Method | setState({ isLoading: true, error: null, output: n... |
| Parameters | Event handler for onClick |
| Authentication | N/A |
| Error Handling | Button is disabled if script or sample data textar... |
| Performance | Immediate feedback to user (<50ms). |

### 2.5.2.0 API Request

#### 2.5.2.1 Source Id

REPO-APP-UI-005

#### 2.5.2.2 Target Id

REPO-APP-API-001

#### 2.5.2.3 Message

Sends script and sample data for preview.

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ API Request

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

Returns 200 OK with transformed JSON, 400 with structured error, or 500 for server failures.

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚úÖ Yes

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | POST /api/v1/transformations/preview |
| Parameters | RequestBody: { scriptText: string, sampleData: Jso... |
| Authentication | Attach Bearer token (JWT) in Authorization header. |
| Error Handling | Axios client handles network errors (e.g., DNS, co... |
| Performance | Client-side timeout set to 35 seconds to accommoda... |

### 2.5.3.0 Timeout Enforcement

#### 2.5.3.1 Source Id

REPO-APP-API-001

#### 2.5.3.2 Target Id

REPO-APP-API-001

#### 2.5.3.3 Message

ScriptPreviewController instantiates CancellationTokenSource with a 30s timeout.

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Timeout Enforcement

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

CancellationToken is passed down the call stack.

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚ùå No

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | new CancellationTokenSource(TimeSpan.FromSeconds(3... |
| Parameters | Configured timeout value (default 30s) from IConfi... |
| Authentication | N/A |
| Error Handling | The token source will trigger cancellation after t... |
| Performance | Minimal overhead. |

### 2.5.4.0 Service Invocation

#### 2.5.4.1 Source Id

REPO-APP-API-001

#### 2.5.4.2 Target Id

REPO-LIB-JINT-002

#### 2.5.4.3 Message

ScriptExecutionService calls wrapper to execute the script.

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Service Invocation

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

Returns a result object containing either the transformed JsonNode or a structured error.

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚úÖ Yes

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process Method Call |
| Method | Task<ScriptExecutionResult> IScriptEngineWrapper.E... |
| Parameters | script (string), input (JsonNode), cancellationTok... |
| Authentication | N/A |
| Error Handling | Catches exceptions from the wrapper and maps them ... |
| Performance | The call itself is fast; duration is dependent on ... |

### 2.5.5.0 Sandboxed Execution

#### 2.5.5.1 Source Id

REPO-LIB-JINT-002

#### 2.5.5.2 Target Id

REPO-LIB-JINT-002

#### 2.5.5.3 Message

Creates secure Jint engine, applies constraints (memory, statement count, no CLR), and executes script.

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Sandboxed Execution

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message

Transformed JSON as Jint.Native.Json.JsonInstance or throws an exception.

#### 2.5.5.8 Has Return

‚úÖ Yes

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | engine.Execute(script).GetCompletionValue() |
| Parameters | Engine configured with options.LimitMemory(), opti... |
| Authentication | N/A |
| Error Handling | Catches Jint.Runtime exceptions (JavaScriptExcepti... |
| Performance | Monitored via prometheus-net histogram for executi... |

### 2.5.6.0 Service Return

#### 2.5.6.1 Source Id

REPO-LIB-JINT-002

#### 2.5.6.2 Target Id

REPO-APP-API-001

#### 2.5.6.3 Message

Returns successful execution result.

#### 2.5.6.4 Sequence Number

6

#### 2.5.6.5 Type

üîπ Service Return

#### 2.5.6.6 Is Synchronous

‚úÖ Yes

#### 2.5.6.7 Return Message

ScriptExecutionResult { IsSuccess: true, Output: JsonNode }

#### 2.5.6.8 Has Return

‚úÖ Yes

#### 2.5.6.9 Is Activation

‚ùå No

#### 2.5.6.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process Method Return |
| Method | return result; |
| Parameters | The result object wrapping the transformed JSON. |
| Authentication | N/A |
| Error Handling | N/A on success path. |
| Performance | Immediate. |

### 2.5.7.0 API Response

#### 2.5.7.1 Source Id

REPO-APP-API-001

#### 2.5.7.2 Target Id

REPO-APP-UI-005

#### 2.5.7.3 Message

Returns 200 OK with transformed JSON payload.

#### 2.5.7.4 Sequence Number

7

#### 2.5.7.5 Type

üîπ API Response

#### 2.5.7.6 Is Synchronous

‚úÖ Yes

#### 2.5.7.7 Return Message



#### 2.5.7.8 Has Return

‚ùå No

#### 2.5.7.9 Is Activation

‚ùå No

#### 2.5.7.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | HTTP/1.1 200 OK |
| Parameters | ResponseBody: Transformed JSON object. |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | Dependent on network latency and payload size. |

### 2.5.8.0 UI State Transition

#### 2.5.8.1 Source Id

REPO-APP-UI-005

#### 2.5.8.2 Target Id

REPO-APP-UI-005

#### 2.5.8.3 Message

Receives successful response, sets state to 'loaded', and displays formatted JSON in the output pane.

#### 2.5.8.4 Sequence Number

8

#### 2.5.8.5 Type

üîπ UI State Transition

#### 2.5.8.6 Is Synchronous

‚úÖ Yes

#### 2.5.8.7 Return Message



#### 2.5.8.8 Has Return

‚ùå No

#### 2.5.8.9 Is Activation

‚ùå No

#### 2.5.8.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | React State Management |
| Method | setState({ isLoading: false, output: response.data... |
| Parameters | The data from the Axios response. |
| Authentication | N/A |
| Error Handling | Sanitizes the output to prevent potential XSS vuln... |
| Performance | JSON formatting/highlighting component should rend... |

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content



```
Error Scenario: Timeout
If the script runs longer than 30s, the CancellationToken is triggered. The ScriptExecutionService catches the OperationCanceledException, logs it (REQ-DTR-011), and returns a structured error. The API responds with a 400 Bad Request.
```

#### 2.6.1.2 Position

bottom

#### 2.6.1.3 Participant Id

REPO-APP-API-001

#### 2.6.1.4 Sequence Number

4

### 2.6.2.0 Content

#### 2.6.2.1 Content



```
Error Scenario: Script Error
If Jint throws a JavaScriptException, the wrapper catches it, extracts details (message, line, stack), and returns a structured error. The API responds with a 400 Bad Request and the structured error payload (REQ-DTR-006). The UI displays this information in the output pane.
```

#### 2.6.2.2 Position

bottom

#### 2.6.2.3 Participant Id

REPO-LIB-JINT-002

#### 2.6.2.4 Sequence Number

5

### 2.6.3.0 Content

#### 2.6.3.1 Content



```
Error Scenario: Sandbox Violation
If Jint throws MemoryLimitExceededException, the wrapper catches it, logs a security violation event (REQ-DTR-001), and the API returns a 500 Internal Server Error to prevent revealing internal security mechanisms. The UI displays a generic server error message.
```

#### 2.6.3.2 Position

bottom

#### 2.6.3.3 Participant Id

REPO-LIB-JINT-002

#### 2.6.3.4 Sequence Number

5

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The API Controller must have an `[Authorize]` attr... |
| Performance Targets | The entire P95 end-to-end latency (from button cli... |
| Error Handling Strategy | The UI's API client (Axios) must have a global err... |
| Testing Considerations | Unit tests should cover the Jint wrapper's excepti... |
| Monitoring Requirements | The API should increment Prometheus counters for p... |
| Deployment Considerations | The 30-second timeout and Jint sandbox constraints... |


# 1 Overview

## 1.1 Diagram Id

SEQ-BP-001

## 1.2 Name

Report Generation with Data Transformation

## 1.3 Description

During a report generation process, the system fetches the report's entire dataset, buffers it into memory as a `JsonNode`, executes the active version of the associated transformation script, records performance metrics, and uses the transformed output for the remainder of the report generation.

## 1.4 Type

üîπ BusinessProcess

## 1.5 Purpose

To apply user-defined data manipulation logic as an integral step in the report generation pipeline.

## 1.6 Complexity

High

## 1.7 Priority

üö® Critical

## 1.8 Frequency

OnDemand

## 1.9 Participants

- REPO-APP-API-001
- REPO-LIB-JINT-002
- REPO-LIB-DATA-003

## 1.10 Key Interactions

- A report generation job is initiated for a report with an associated script.
- The system fetches the entire dataset from the data source, checking it against the max size limit.
- The dataset is buffered into memory as a `System.Text.Json.JsonNode` (REQ-DTR-002).
- `ScriptExecutionService` retrieves the active version of the script from the database.
- `JintEngineWrapper` is invoked to execute the script against the `JsonNode` data.
- Upon completion, performance metrics (`transformation_execution_time_seconds`, `transformation_memory_usage_bytes`) are recorded in Prometheus.
- The transformed `JsonNode` is passed to the next stage of the report generation process.

## 1.11 Triggers

- A scheduled or on-demand report generation job starts for a report configured with a transformation script.

## 1.12 Outcomes

- The report is generated using the transformed data.
- The job is marked as 'Completed' or 'Failed' based on the script execution outcome.

## 1.13 Business Rules

- The entire dataset must be buffered into memory (REQ-DTR-002).
- Execution must adhere to the secure sandbox constraints (REQ-DTR-001).
- The maximum dataset size for transformation is configurable (default 256MB) (REQ-DTR-009).

## 1.14 Error Scenarios

- The dataset exceeds the configured maximum size; the job fails before script execution.
- The script execution fails (runtime error or constraint violation); the job is marked as 'Failed' with a clear error reference (REQ-DTR-011).

## 1.15 Integration Points

- Report Generation Engine
- Application Database
- Prometheus Monitoring System

# 2.0 Details

## 2.1 Diagram Id

SEQ-BP-001-IMPL

## 2.2 Name

Detailed Implementation: Report Generation with Data Transformation

## 2.3 Description

Provides a comprehensive technical sequence for executing a data transformation as part of a larger report generation business process. The sequence is orchestrated by the ScriptExecutionService, which manages data buffering, script retrieval, secure execution via a sandboxed Jint engine, and performance metric recording. The process is designed to be atomic; any failure results in the entire report job being marked as 'Failed'.

## 2.4 Participants

### 2.4.1 Application Service/Orchestrator

#### 2.4.1.1 Repository Id

REPO-APP-API-001

#### 2.4.1.2 Display Name

TransformationEngine.Api

#### 2.4.1.3 Type

üîπ Application Service/Orchestrator

#### 2.4.1.4 Technology

ASP.NET Core 8, C# 12

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #1168BD |
| Stereotype | ScriptExecutionService |

### 2.4.2.0 Data Access Library

#### 2.4.2.1 Repository Id

REPO-LIB-DATA-003

#### 2.4.2.2 Display Name

TransformationEngine.Data

#### 2.4.2.3 Type

üîπ Data Access Library

#### 2.4.2.4 Technology

Entity Framework Core 8, C# 12

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #6C3483 |
| Stereotype | Repository |

### 2.4.3.0 Infrastructure Library

#### 2.4.3.1 Repository Id

REPO-LIB-JINT-002

#### 2.4.3.2 Display Name

TransformationEngine.JintWrapper

#### 2.4.3.3 Type

üîπ Infrastructure Library

#### 2.4.3.4 Technology

Jint 3.x, C# 12

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #D35400 |
| Stereotype | Secure JS Engine |

## 2.5.0.0 Interactions

### 2.5.1.0 Self-Invocation

#### 2.5.1.1 Source Id

REPO-APP-API-001

#### 2.5.1.2 Target Id

REPO-APP-API-001

#### 2.5.1.3 Message

1. [Trigger] BeginTransformation(jobId, reportId, sourceDataStream)

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Self-Invocation

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | ScriptExecutionService.ExecuteTransformationAsync |
| Parameters | Guid jobId, Guid reportId, Stream sourceDataStream |
| Authentication | Initial job request is assumed to be authenticated... |
| Error Handling | Outer try-catch block to handle any failure, mark ... |
| Performance | Starts a Stopwatch to measure total execution time... |

#### 2.5.1.11 Nested Interactions

*No items available*

### 2.5.2.0 Business Rule Validation

#### 2.5.2.1 Source Id

REPO-APP-API-001

#### 2.5.2.2 Target Id

REPO-APP-API-001

#### 2.5.2.3 Message

2. Check source data size against configured limit (e.g., 256MB)

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ Business Rule Validation

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message



#### 2.5.2.8 Has Return

‚ùå No

#### 2.5.2.9 Is Activation

‚ùå No

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | Internal validation logic |
| Parameters | sourceDataStream.Length, _config.MaxDatasetSize |
| Authentication | N/A |
| Error Handling | If limit is exceeded, throws DatasetTooLargeExcept... |
| Performance | Minimal overhead. |

#### 2.5.2.11 Nested Interactions

*No items available*

### 2.5.3.0 Data Transformation

#### 2.5.3.1 Source Id

REPO-APP-API-001

#### 2.5.3.2 Target Id

REPO-APP-API-001

#### 2.5.3.3 Message

3. Buffer data into memory as System.Text.Json.JsonNode

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Data Transformation

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

JsonNode inputData

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚ùå No

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | System.Text.Json.JsonNode.ParseAsync(sourceDataStr... |
| Parameters | Stream sourceDataStream |
| Authentication | N/A |
| Error Handling | Catches JsonException for malformed data; fails th... |
| Performance | Memory-intensive operation for large datasets, as ... |

#### 2.5.3.11 Nested Interactions

*No items available*

### 2.5.4.0 Data Retrieval

#### 2.5.4.1 Source Id

REPO-APP-API-001

#### 2.5.4.2 Target Id

REPO-LIB-DATA-003

#### 2.5.4.3 Message

4. GetActiveScriptVersionAsync(reportId)

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Data Retrieval

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

ScriptVersion scriptEntity

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚úÖ Yes

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process (EF Core) |
| Method | ITransformationScriptRepository.GetActiveScriptVer... |
| Parameters | Guid reportId |
| Authentication | N/A |
| Error Handling | Handles DbUpdateException or other transient DB er... |
| Performance | Database query; should be indexed on reportId and ... |

#### 2.5.4.11 Nested Interactions

*No items available*

### 2.5.5.0 Return Data

#### 2.5.5.1 Source Id

REPO-LIB-DATA-003

#### 2.5.5.2 Target Id

REPO-APP-API-001

#### 2.5.5.3 Message

5. return scriptEntity (with decrypted content)

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Return Data

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message



#### 2.5.5.8 Has Return

‚ùå No

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process (EF Core) |
| Method | Return from GetActiveScriptVersionByReportIdAsync |
| Parameters | ScriptVersion object |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | Includes transparent decryption of script content ... |

#### 2.5.5.11 Nested Interactions

*No items available*

### 2.5.6.0 Script Execution

#### 2.5.6.1 Source Id

REPO-APP-API-001

#### 2.5.6.2 Target Id

REPO-LIB-JINT-002

#### 2.5.6.3 Message

6. Execute(scriptEntity.Content, inputData)

#### 2.5.6.4 Sequence Number

6

#### 2.5.6.5 Type

üîπ Script Execution

#### 2.5.6.6 Is Synchronous

‚úÖ Yes

#### 2.5.6.7 Return Message

JsonNode transformedData

#### 2.5.6.8 Has Return

‚úÖ Yes

#### 2.5.6.9 Is Activation

‚úÖ Yes

#### 2.5.6.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | IScriptEngineWrapper.Execute |
| Parameters | string scriptContent, JsonNode inputData |
| Authentication | N/A |
| Error Handling | Throws specific exceptions for constraint violatio... |
| Performance | CPU and memory-bound. This is the core performance... |

#### 2.5.6.11 Nested Interactions

*No items available*

### 2.5.7.0 Return Data

#### 2.5.7.1 Source Id

REPO-LIB-JINT-002

#### 2.5.7.2 Target Id

REPO-APP-API-001

#### 2.5.7.3 Message

7. return transformedData

#### 2.5.7.4 Sequence Number

7

#### 2.5.7.5 Type

üîπ Return Data

#### 2.5.7.6 Is Synchronous

‚úÖ Yes

#### 2.5.7.7 Return Message



#### 2.5.7.8 Has Return

‚ùå No

#### 2.5.7.9 Is Activation

‚ùå No

#### 2.5.7.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | Return from Execute |
| Parameters | JsonNode object |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

#### 2.5.7.11 Nested Interactions

*No items available*

### 2.5.8.0 Monitoring

#### 2.5.8.1 Source Id

REPO-APP-API-001

#### 2.5.8.2 Target Id

REPO-APP-API-001

#### 2.5.8.3 Message

8. Record successful execution metrics

#### 2.5.8.4 Sequence Number

8

#### 2.5.8.5 Type

üîπ Monitoring

#### 2.5.8.6 Is Synchronous

‚úÖ Yes

#### 2.5.8.7 Return Message



#### 2.5.8.8 Has Return

‚ùå No

#### 2.5.8.9 Is Activation

‚ùå No

#### 2.5.8.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process (prometheus-net) |
| Method | _metrics.RecordExecutionTime(duration, scriptId, '... |
| Parameters | TimeSpan duration, Guid scriptId, string outcome |
| Authentication | N/A |
| Error Handling | Instrumentation code is wrapped in its own try-cat... |
| Performance | Low overhead. |

#### 2.5.8.11 Nested Interactions

*No items available*

### 2.5.9.0 Return Result

#### 2.5.9.1 Source Id

REPO-APP-API-001

#### 2.5.9.2 Target Id

REPO-APP-API-001

#### 2.5.9.3 Message

9. Return transformedData to Report Generation Engine

#### 2.5.9.4 Sequence Number

9

#### 2.5.9.5 Type

üîπ Return Result

#### 2.5.9.6 Is Synchronous

‚úÖ Yes

#### 2.5.9.7 Return Message

JsonNode transformedData

#### 2.5.9.8 Has Return

‚úÖ Yes

#### 2.5.9.9 Is Activation

‚ùå No

#### 2.5.9.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | Return from ExecuteTransformationAsync |
| Parameters | JsonNode object |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | N/A |

#### 2.5.9.11 Nested Interactions

*No items available*

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

JintEngineWrapper configures a new engine instance for each execution with strict, configurable constraints: execution timeout, memory allocation limit (default 64MB), statement count limit, and disabled CLR access to create the secure sandbox (REQ-DTR-001).

#### 2.6.1.2 Position

bottom

#### 2.6.1.3 Participant Id

REPO-LIB-JINT-002

#### 2.6.1.4 Sequence Number

6

### 2.6.2.0 Content

#### 2.6.2.1 Content

If any step fails, the ScriptExecutionService catches the exception, records a 'failed' outcome metric to Prometheus, logs the detailed error, and marks the parent report job as 'Failed' (REQ-DTR-011). No partial results are returned.

#### 2.6.2.2 Position

bottom

#### 2.6.2.3 Participant Id

REPO-APP-API-001

#### 2.6.2.4 Sequence Number

1

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The initial report job trigger must be authorized ... |
| Performance Targets | The entire process must meet the benchmark defined... |
| Error Handling Strategy | The process employs a Fail-Fast strategy. Any unre... |
| Testing Considerations | Unit tests must cover the JintEngineWrapper's sand... |
| Monitoring Requirements | The following Prometheus metrics must be implement... |
| Deployment Considerations | The feature is controlled by a system-wide feature... |


# 1 Overview

## 1.1 Diagram Id

SEQ-SF-001

## 1.2 Name

Backend Detects and Logs a Sandbox Constraint Violation

## 1.3 Description

During script execution, the Jint engine detects a configured constraint (e.g., memory limit, statement count) has been breached. The engine throws a specific exception, which is caught by the wrapper, a Prometheus metric is incremented, and a detailed security event is logged to a dedicated database table.

## 1.4 Type

ðŸ”¹ SecurityFlow

## 1.5 Purpose

To enforce the secure sandbox environment, prevent resource exhaustion (DoS), and maintain a compliant security audit trail.

## 1.6 Complexity

High

## 1.7 Priority

ðŸš¨ Critical

## 1.8 Frequency

OnDemand

## 1.9 Participants

- REPO-LIB-JINT-002
- REPO-APP-API-001
- REPO-LIB-DATA-003

## 1.10 Key Interactions

- A script executing in the Jint engine exceeds a limit (e.g., memory).
- Jint throws a specific exception (e.g., `Jint.Runtime.MemoryLimitExceededException`).
- The `JintEngineWrapper`'s try...catch block catches the specific exception.
- The wrapper increments the `transformation_constraint_violations_total` Prometheus metric, labeled with `violation_type='MEMORY_LIMIT'`.
- The wrapper publishes a `ScriptSecurityViolationOccurred` event.
- An asynchronous event handler saves the event details to the `SecurityViolationLog` table.
- The wrapper re-throws a custom application exception to signal the failure to the calling service.

## 1.11 Triggers

- A script attempts to use more resources (memory, CPU time, statements) than allowed by the sandbox configuration.

## 1.12 Outcomes

- The script execution is immediately terminated.
- A detailed, immutable security log entry is created for forensic analysis.
- The calling process (report job or preview) is failed cleanly.

## 1.13 Business Rules

- CLR access must be disabled (REQ-DTR-001).
- Constraints (timeout, memory, statement count) must be configurable (REQ-DTR-001).
- All violations must be logged to a security audit trail (REQ-DTR-001).
- The audit trail must be compliant with SOC 2 / ISO 27001 (REQ-DTR-020).

## 1.14 Error Scenarios

- The security logging database is unavailable, leading to a critical failure that is heavily alerted.

## 1.15 Integration Points

- Application Database (SecurityViolationLog table)
- Prometheus Monitoring System

# 2.0 Details

## 2.1 Diagram Id

SEQ-SF-001

## 2.2 Name

Implementation: Sandbox Constraint Violation Detection and Logging

## 2.3 Description

Provides a comprehensive technical specification for the sequence initiated when a user-provided script, executing within the Jint engine, breaches a configured sandbox security constraint. The sequence details the immediate termination of the script, the specific exception handling path, the real-time increment of a Prometheus security metric, the asynchronous publication of a domain event for security auditing, and the propagation of a typed exception back to the original caller.

## 2.4 Participants

### 2.4.1 Application Service

#### 2.4.1.1 Repository Id

REPO-APP-API-001

#### 2.4.1.2 Display Name

ScriptExecutionService

#### 2.4.1.3 Type

ðŸ”¹ Application Service

#### 2.4.1.4 Technology

.NET 8, C#

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #1168bd |
| Stereotype | Caller |

### 2.4.2.0 Infrastructure Wrapper

#### 2.4.2.1 Repository Id

REPO-LIB-JINT-002

#### 2.4.2.2 Display Name

JintEngineWrapper

#### 2.4.2.3 Type

ðŸ”¹ Infrastructure Wrapper

#### 2.4.2.4 Technology

.NET 8, Jint

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #d9534f |
| Stereotype | Security Boundary |

### 2.4.3.0 Monitoring Library

#### 2.4.3.1 Repository Id

PrometheusClient

#### 2.4.3.2 Display Name

PrometheusClient

#### 2.4.3.3 Type

ðŸ”¹ Monitoring Library

#### 2.4.3.4 Technology

prometheus-net

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #f0ad4e |
| Stereotype | Observability |

### 2.4.4.0 Messaging Pattern

#### 2.4.4.1 Repository Id

InProcessEventBus

#### 2.4.4.2 Display Name

InProcessEventBus

#### 2.4.4.3 Type

ðŸ”¹ Messaging Pattern

#### 2.4.4.4 Technology

MediatR

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #5bc0de |
| Stereotype | Decoupling |

### 2.4.5.0 Event Handler

#### 2.4.5.1 Repository Id

SecurityViolationEventHandler

#### 2.4.5.2 Display Name

SecurityViolationEventHandler

#### 2.4.5.3 Type

ðŸ”¹ Event Handler

#### 2.4.5.4 Technology

.NET 8, C#

#### 2.4.5.5 Order

5

#### 2.4.5.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #337ab7 |
| Stereotype | Asynchronous Worker |

### 2.4.6.0 Data Repository

#### 2.4.6.1 Repository Id

REPO-LIB-DATA-003

#### 2.4.6.2 Display Name

SecurityViolationLogRepository

#### 2.4.6.3 Type

ðŸ”¹ Data Repository

#### 2.4.6.4 Technology

Entity Framework Core 8

#### 2.4.6.5 Order

6

#### 2.4.6.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #5cb85c |
| Stereotype | Persistence |

## 2.5.0.0 Interactions

- {'sourceId': 'REPO-APP-API-001', 'targetId': 'REPO-LIB-JINT-002', 'message': 'Execute(script, inputJson, cancellationToken)', 'sequenceNumber': 1, 'type': 'Method Call', 'isSynchronous': True, 'returnMessage': 'Throws SandboxConstraintViolationException', 'hasReturn': True, 'isActivation': True, 'technicalDetails': {'protocol': 'In-process', 'method': 'IScriptEngineWrapper.Execute', 'parameters': 'string script, JsonNode inputJson, CancellationToken cancellationToken', 'authentication': 'N/A (Internal trusted call)', 'errorHandling': 'Expects a typed exception on script execution failure.', 'performance': {'latency': '< 10ms for call overhead'}}, 'nestedInteractions': [{'sourceId': 'REPO-LIB-JINT-002', 'targetId': 'REPO-LIB-JINT-002', 'message': '[ALT: Constraint Violation] engine.Execute(script)', 'sequenceNumber': 2, 'type': 'Self Call / Exception Path', 'isSynchronous': True, 'returnMessage': 'Throws Jint.Runtime.MemoryLimitExceededException', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'In-process', 'method': 'Jint.Engine.Execute', 'parameters': 'string script', 'authentication': 'N/A', 'errorHandling': 'The core try-catch block is wrapped around this call to detect security violations.', 'performance': {'latency': 'Variable, dependent on script complexity.'}}}, {'sourceId': 'REPO-LIB-JINT-002', 'targetId': 'REPO-LIB-JINT-002', 'message': 'catch (Jint.Runtime.MemoryLimitExceededException ex)', 'sequenceNumber': 3, 'type': 'Exception Handling', 'isSynchronous': True, 'returnMessage': '', 'hasReturn': False, 'isActivation': False, 'technicalDetails': {'protocol': 'In-process', 'method': 'try-catch block', 'parameters': 'Jint.Runtime.MemoryLimitExceededException ex', 'authentication': 'N/A', 'errorHandling': 'Catches the specific exception from Jint to begin the security response.', 'performance': {'latency': 'Negligible'}}}, {'sourceId': 'REPO-LIB-JINT-002', 'targetId': 'PrometheusClient', 'message': "IncrementConstraintViolationMetric('MEMORY_LIMIT')", 'sequenceNumber': 4, 'type': 'Metric Increment', 'isSynchronous': True, 'returnMessage': '', 'hasReturn': False, 'isActivation': False, 'technicalDetails': {'protocol': 'In-process', 'method': 'Counter.WithLabels(...).Inc()', 'parameters': "violation_type='MEMORY_LIMIT'", 'authentication': 'N/A', 'errorHandling': 'Fail-safe; failure to increment metric should be logged but must not interrupt the security logging flow.', 'performance': {'latency': '< 1ms'}}}, {'sourceId': 'REPO-LIB-JINT-002', 'targetId': 'InProcessEventBus', 'message': 'Publish(new ScriptSecurityViolationOccurred(...))', 'sequenceNumber': 5, 'type': 'Event Publication', 'isSynchronous': False, 'returnMessage': '', 'hasReturn': False, 'isActivation': False, 'technicalDetails': {'protocol': 'In-process', 'method': 'IMediator.Publish', 'parameters': 'ScriptSecurityViolationOccurred event DTO', 'authentication': 'N/A', 'errorHandling': "Fire-and-forget from the publisher's perspective. The event bus and handler are responsible for delivery guarantees.", 'performance': {'latency': '< 1ms'}}, 'nestedInteractions': [{'sourceId': 'InProcessEventBus', 'targetId': 'SecurityViolationEventHandler', 'message': 'Handle(ScriptSecurityViolationOccurred event, ...)', 'sequenceNumber': 6, 'type': 'Event Dispatch', 'isSynchronous': False, 'returnMessage': '', 'hasReturn': False, 'isActivation': True, 'technicalDetails': {'protocol': 'In-process', 'method': 'INotificationHandler<ScriptSecurityViolationOccurred>.Handle', 'parameters': 'ScriptSecurityViolationOccurred event', 'authentication': 'N/A', 'errorHandling': 'Handler must implement its own retry logic for transient database errors and log failures to a centralized system if the DB write ultimately fails.', 'performance': {'latency': 'Dependent on database performance.'}}, 'nestedInteractions': [{'sourceId': 'SecurityViolationEventHandler', 'targetId': 'REPO-LIB-DATA-003', 'message': 'AddAsync(securityViolationLog)', 'sequenceNumber': 7, 'type': 'Database Write', 'isSynchronous': True, 'returnMessage': 'Task', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'EF Core / Npgsql', 'method': 'DbContext.AddAsync / DbContext.SaveChangesAsync', 'parameters': 'SecurityViolationLog entity object', 'authentication': 'Service account with append-only permissions to the SecurityViolationLog table.', 'errorHandling': 'Throws DbUpdateException on failure, which must be caught and handled by the calling event handler (e.g., retry logic).', 'performance': {'latency': 'Typically 5-50ms'}}}]}]}, {'sourceId': 'REPO-LIB-JINT-002', 'targetId': 'REPO-APP-API-001', 'message': 'throw new SandboxConstraintViolationException(...)', 'sequenceNumber': 8, 'type': 'Exception Propagation', 'isSynchronous': True, 'returnMessage': '', 'hasReturn': False, 'isActivation': False, 'technicalDetails': {'protocol': 'In-process', 'method': 'throw', 'parameters': 'Custom SandboxConstraintViolationException, wrapping the original Jint exception.', 'authentication': 'N/A', 'errorHandling': 'Propagates a clean, typed exception to the application layer, signaling a non-transient failure.', 'performance': {'latency': 'Negligible'}}}]}

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

Crucial Security Checkpoint: The try...catch block inside the JintEngineWrapper is the primary defense mechanism against resource exhaustion attacks from user scripts.

#### 2.6.1.2 Position

top

#### 2.6.1.3 Participant Id

REPO-LIB-JINT-002

#### 2.6.1.4 Sequence Number

3

### 2.6.2.0 Content

#### 2.6.2.1 Content

Asynchronous Logging: Security logging is intentionally asynchronous via an event bus. This ensures that a delay or failure in writing to the audit database does not block the primary execution thread from failing fast and returning an error to the user.

#### 2.6.2.2 Position

right

#### 2.6.2.3 Participant Id

InProcessEventBus

#### 2.6.2.4 Sequence Number

5

### 2.6.3.0 Content

#### 2.6.3.1 Content

Compliance Mandate (SOC 2/ISO 27001): The data written to the SecurityViolationLog table must be immutable and retained for at least one year. This is enforced via append-only database permissions and retention policies.

#### 2.6.3.2 Position

bottom

#### 2.6.3.3 Participant Id

REPO-LIB-DATA-003

#### 2.6.3.4 Sequence Number

7

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The Jint engine instance MUST be configured with `... |
| Performance Targets | The overhead of the try-catch and metric increment... |
| Error Handling Strategy | The `SecurityViolationEventHandler` must be design... |
| Testing Considerations | Unit tests must be created for the `JintEngineWrap... |
| Monitoring Requirements | A Prometheus alert rule MUST be configured for `ra... |
| Deployment Considerations | The initial deployment must include the database m... |


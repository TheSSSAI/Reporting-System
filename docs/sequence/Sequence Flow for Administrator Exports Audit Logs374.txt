# 1 Overview

## 1.1 Diagram Id

SEQ-CF-002

## 1.2 Name

Administrator Exports Audit Logs

## 1.3 Description

An Administrator navigates to the System Settings area of the Control Panel. They specify a date range and an output format (CSV or JSON) and initiate an export of the audit logs. The backend queries the audit log storage, serializes the data, and provides the file for the administrator to download.

## 1.4 Type

üîπ ComplianceFlow

## 1.5 Purpose

To provide administrators with the ability to export audit trail data for offline analysis, archival, or submission to external auditors, fulfilling a key compliance requirement.

## 1.6 Complexity

Medium

## 1.7 Priority

üü° Medium

## 1.8 Frequency

OnDemand

## 1.9 Participants

- presentationlayerreact
- apiweblayer
- application_layer
- infrastructure_layer

## 1.10 Key Interactions

- Admin selects date range and format in the UI and clicks 'Export'.
- UI sends a request to the audit log export API endpoint with the specified parameters.
- Application Layer receives the request and validates permissions.
- Infrastructure Layer queries the AuditLog table for records within the date range.
- The result set is serialized into the requested format (CSV or JSON).
- The API returns the data as a file stream, prompting a download in the user's browser.

## 1.11 Triggers

- Administrator requests an export of the audit logs.

## 1.12 Outcomes

- A file containing the audit logs for the specified period is downloaded by the administrator.

## 1.13 Business Rules

- Only users with the Administrator role can export audit logs.
- Export must support both CSV and JSON formats.

## 1.14 Error Scenarios

- The requested date range is too large and causes a query timeout or excessive memory usage.
- Error during data serialization.

## 1.15 Integration Points

*No items available*

# 2.0 Details

## 2.1 Diagram Id

SEQ-CF-002-IMPL

## 2.2 Name

Implementation Sequence: Administrator Audit Log Export

## 2.3 Description

Provides a detailed technical specification for exporting audit logs. An Administrator initiates the export from a React-based Control Panel. The request is handled by an ASP.NET Core API endpoint, which delegates to an application service. The service enforces business rules, retrieves data via a repository using a streaming pattern to handle large datasets, serializes the data on-the-fly, and returns a file stream to the client for download. This sequence prioritizes security, performance for large data volumes, and compliance evidence preservation.

## 2.4 Participants

### 2.4.1 Frontend Application

#### 2.4.1.1 Repository Id

presentationlayerreact

#### 2.4.1.2 Display Name

Control Panel (UI)

#### 2.4.1.3 Type

üîπ Frontend Application

#### 2.4.1.4 Technology

React 18, TypeScript, Axios

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #4287f5 |
| Stereotype | UI |

### 2.4.2.0 API Controller

#### 2.4.2.1 Repository Id

apiweblayer

#### 2.4.2.2 Display Name

API/Web Layer

#### 2.4.2.3 Type

üîπ API Controller

#### 2.4.2.4 Technology

ASP.NET Core 8

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #f5a623 |
| Stereotype | Controller |

### 2.4.3.0 Application Service

#### 2.4.3.1 Repository Id

application_layer

#### 2.4.3.2 Display Name

Application Layer

#### 2.4.3.3 Type

üîπ Application Service

#### 2.4.3.4 Technology

.NET 8

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #7ed321 |
| Stereotype | Service |

### 2.4.4.0 Repository/Data Access

#### 2.4.4.1 Repository Id

infrastructure_layer

#### 2.4.4.2 Display Name

Infrastructure Layer

#### 2.4.4.3 Type

üîπ Repository/Data Access

#### 2.4.4.4 Technology

EF Core 8 / MongoDB C# Driver

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | participant |
| Color | #9013fe |
| Stereotype | Repository |

## 2.5.0.0 Interactions

### 2.5.1.0 API Request

#### 2.5.1.1 Source Id

presentationlayerreact

#### 2.5.1.2 Target Id

apiweblayer

#### 2.5.1.3 Message

1. RequestAuditLogExport(exportParams)

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ API Request

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message

200 OK (File Stream) or Error Response

#### 2.5.1.8 Has Return

‚úÖ Yes

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | POST /api/v1/auditlogs/export |
| Parameters | RequestBody: { startDate: string, endDate: string,... |
| Authentication | Requires valid JWT. Header: `Authorization: Bearer... |
| Error Handling | Client handles 400 (Invalid Params), 401 (Unauthor... |
| Performance | Client initiates a file download upon receiving th... |

### 2.5.2.0 Method Invocation

#### 2.5.2.1 Source Id

apiweblayer

#### 2.5.2.2 Target Id

application_layer

#### 2.5.2.3 Message

2. ExportLogsAsync(ExportAuditLogsDto dto)

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ Method Invocation

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

Task<IActionResult>

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚úÖ Yes

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process |
| Method | Calls `IAuditLogService.ExportLogsAsync` |
| Parameters | Validated and mapped DTO containing date range and... |
| Authentication | Handled by `[Authorize(Roles = "Administrator")]` ... |
| Error Handling | Catches exceptions from the service layer and maps... |
| Performance | Passes `HttpContext.RequestAborted` as a Cancellat... |

### 2.5.3.0 Method Invocation

#### 2.5.3.1 Source Id

application_layer

#### 2.5.3.2 Target Id

infrastructure_layer

#### 2.5.3.3 Message

3. GetLogsByDateRangeAsync(startDate, endDate, maxRecords)

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Method Invocation

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

IAsyncEnumerable<AuditLog>

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚úÖ Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process |
| Method | Calls `IAuditLogRepository.GetLogsByDateRangeAsync... |
| Parameters | `DateTime startDate`, `DateTime endDate`, `int max... |
| Authentication | N/A (internal call) |
| Error Handling | The repository will throw `TimeoutException` if th... |
| Performance | The method returns an `IAsyncEnumerable` to stream... |

### 2.5.4.0 Database Query

#### 2.5.4.1 Source Id

infrastructure_layer

#### 2.5.4.2 Target Id

infrastructure_layer

#### 2.5.4.3 Message

4. Execute Query

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Database Query

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

Cursor / Data Reader

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚ùå No

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | MongoDB Wire Protocol |
| Method | Executes a `find` query on the `AuditLog` collecti... |
| Parameters | Query: `{ timestamp: { $gte: ISODate(...), $lte: I... |
| Authentication | Uses connection string credentials. |
| Error Handling | Relies on the MongoDB driver for connection and qu... |
| Performance | Requires a compound index on `{ timestamp: -1 }` f... |

### 2.5.5.0 Internal Processing

#### 2.5.5.1 Source Id

application_layer

#### 2.5.5.2 Target Id

application_layer

#### 2.5.5.3 Message

5. Stream and Serialize Data

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Internal Processing

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message

Serialized data written to output stream

#### 2.5.5.8 Has Return

‚ùå No

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process |
| Method | Iterates the `IAsyncEnumerable<AuditLog>` |
| Parameters | For each `AuditLog` object, it is serialized to a ... |
| Authentication | N/A |
| Error Handling | Serialization is wrapped in a try-catch block. A f... |
| Performance | This on-the-fly serialization avoids buffering the... |

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

Security Checkpoint: The `AuditLogsController` endpoint is decorated with `[Authorize(Roles = "Administrator")]`, ensuring only authenticated administrators can initiate an export. This is a critical access control for compliance.

#### 2.6.1.2 Position

top-right

#### 2.6.1.3 Participant Id

apiweblayer

#### 2.6.1.4 Sequence Number

1

### 2.6.2.0 Content

#### 2.6.2.1 Content

Performance Pattern: The use of `IAsyncEnumerable<T>` combined with stream-based serialization is the core architectural pattern to fulfill performance and reliability requirements for large data exports. It prevents OutOfMemoryException and allows the first bytes of the file to be sent to the client almost immediately.

#### 2.6.2.2 Position

bottom-left

#### 2.6.2.3 Participant Id

application_layer

#### 2.6.2.4 Sequence Number

5

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | 1. **RBAC**: Access to the export endpoint MUST be... |
| Performance Targets | 1. **Time to First Byte**: For exports up to 100,0... |
| Error Handling Strategy | 1. **Invalid Input (400)**: Return a 400 Bad Reque... |
| Testing Considerations | 1. **Functional**: Verify that both CSV and JSON f... |
| Monitoring Requirements | 1. **Logs**: Log the start and completion of every... |
| Deployment Considerations | The `AuditExportMaxRecords` configuration value mu... |


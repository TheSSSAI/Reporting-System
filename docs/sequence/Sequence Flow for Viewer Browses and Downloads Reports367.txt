# 1 Overview

## 1.1 Diagram Id

SEQ-UJ-002

## 1.2 Name

Viewer Browses and Downloads Reports

## 1.3 Description

An authenticated End-User (Viewer) logs into the system and uses the Report Viewer interface to search, filter, and access generated reports according to their permissions. They can view HTML reports directly or download artifacts in other formats like PDF or CSV.

## 1.4 Type

üîπ UserJourney

## 1.5 Purpose

To allow end-users to consume the reports generated by the system, fulfilling a primary use case.

## 1.6 Complexity

Medium

## 1.7 Priority

üî¥ High

## 1.8 Frequency

OnDemand

## 1.9 Participants

- presentationlayerreact
- apiweblayer
- application_layer
- infrastructure_layer

## 1.10 Key Interactions

- User logs in and navigates to the Report Viewer UI.
- React UI sends an API request to fetch a list of accessible reports for the user's role.
- Application Layer enforces Role-Based Access Control (RBAC) to filter reports.
- Infrastructure Layer queries the JobExecutionLog and ReportConfiguration tables.
- User searches/filters the list in the UI, triggering further API calls.
- User clicks a report to view (HTML is rendered in-browser) or download (a request is made to a secure download endpoint).

## 1.11 Triggers

- User accesses the Report Viewer page.

## 1.12 Outcomes

- User can see a list of reports they are permitted to access.
- User can successfully view or download a selected report artifact.

## 1.13 Business Rules

- Users can only see reports for which their assigned role has been granted access.
- The primary administrator account can see all reports.

## 1.14 Error Scenarios

- User attempts to access a report they do not have permission for.
- The requested report artifact is missing from storage.

## 1.15 Integration Points

*No items available*

# 2.0 Details

## 2.1 Diagram Id

SEQ-UJ-002

## 2.2 Name

Implementation: Viewer Browses and Downloads Reports

## 2.3 Description

Technical sequence for an authenticated End-User (Viewer) interacting with the Report Viewer. This covers the initial data fetch, server-side RBAC filtering, UI state management, user-driven filtering, and the process for securely downloading a report artifact. The implementation emphasizes the clear separation of concerns defined by the Clean Architecture.

## 2.4 Participants

### 2.4.1 UI/Client

#### 2.4.1.1 Repository Id

presentation_layer_react

#### 2.4.1.2 Display Name

Presentation: Report Viewer (React SPA)

#### 2.4.1.3 Type

üîπ UI/Client

#### 2.4.1.4 Technology

React 18, Zustand, Axios

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #4287f5 |
| Stereotype | UI |

### 2.4.2.0 API Gateway/Controller

#### 2.4.2.1 Repository Id

api_web_layer

#### 2.4.2.2 Display Name

API/Web Layer

#### 2.4.2.3 Type

üîπ API Gateway/Controller

#### 2.4.2.4 Technology

ASP.NET Core 8

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #f5a742 |
| Stereotype | Controller |

### 2.4.3.0 Application Service

#### 2.4.3.1 Repository Id

application_layer

#### 2.4.3.2 Display Name

Application Layer

#### 2.4.3.3 Type

üîπ Application Service

#### 2.4.3.4 Technology

.NET 8

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #42f584 |
| Stereotype | Service |

### 2.4.4.0 Data Access/External Service

#### 2.4.4.1 Repository Id

infrastructure_layer

#### 2.4.4.2 Display Name

Infrastructure Layer

#### 2.4.4.3 Type

üîπ Data Access/External Service

#### 2.4.4.4 Technology

Entity Framework Core 8, C#

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #f54269 |
| Stereotype | Repository |

## 2.5.0.0 Interactions

### 2.5.1.0 Component Lifecycle

#### 2.5.1.1 Source Id

presentation_layer_react

#### 2.5.1.2 Target Id

presentation_layer_react

#### 2.5.1.3 Message

User navigates to '/reports'. React Router mounts `ReportViewerPage`. `useEffect` hook triggers data fetch and sets UI state to 'loading'.

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Component Lifecycle

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

##### 2.5.1.10.1 Protocol

Internal

##### 2.5.1.10.2 Method

useEffect()

##### 2.5.1.10.3 Parameters

- deps: [] (runs once on mount)

##### 2.5.1.10.4 Authentication

N/A

##### 2.5.1.10.5 Error Handling

Component `ErrorBoundary` catches rendering errors.

##### 2.5.1.10.6 Performance

###### 2.5.1.10.6.1 Latency

Component should render skeleton/loader with LCP < 1.5s.

### 2.5.2.0.0.0 API Request

#### 2.5.2.1.0.0 Source Id

presentation_layer_react

#### 2.5.2.2.0.0 Target Id

api_web_layer

#### 2.5.2.3.0.0 Message

GET /api/v1/reports/viewer

#### 2.5.2.4.0.0 Sequence Number

2

#### 2.5.2.5.0.0 Type

üîπ API Request

#### 2.5.2.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.2.7.0.0 Return Message

200 OK: ReportViewerItemDto[] | 401 Unauthorized | 500 Internal Server Error

#### 2.5.2.8.0.0 Has Return

‚úÖ Yes

#### 2.5.2.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.2.10.0.0 Technical Details

##### 2.5.2.10.1.0 Protocol

HTTPS

##### 2.5.2.10.2.0 Method

GET

##### 2.5.2.10.3.0 Parameters

- Headers: { Authorization: 'Bearer <JWT>' }

##### 2.5.2.10.4.0 Authentication

JWT Bearer Token required.

##### 2.5.2.10.5.0 Error Handling

Axios interceptor handles 401 (redirect to login) and other errors, updating UI state to 'error'.

##### 2.5.2.10.6.0 Performance

###### 2.5.2.10.6.1 Latency

Request timeout set to 15 seconds.

### 2.5.3.0.0.0 Method Call

#### 2.5.3.1.0.0 Source Id

api_web_layer

#### 2.5.3.2.0.0 Target Id

application_layer

#### 2.5.3.3.0.0 Message

reportsController.GetReports(userContext)

#### 2.5.3.4.0.0 Sequence Number

3

#### 2.5.3.5.0.0 Type

üîπ Method Call

#### 2.5.3.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.3.7.0.0 Return Message

List<ReportViewerItemDto>

#### 2.5.3.8.0.0 Has Return

‚úÖ Yes

#### 2.5.3.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.3.10.0.0 Technical Details

##### 2.5.3.10.1.0 Protocol

In-process

##### 2.5.3.10.2.0 Method

GetAccessibleReportsAsync(userId, userRoles)

##### 2.5.3.10.3.0 Parameters

- User context extracted from JWT claims by ASP.NET Core Identity.

##### 2.5.3.10.4.0 Authentication

Authorization policies applied at the controller level.

##### 2.5.3.10.5.0 Error Handling

Global exception handler catches exceptions, logs them, and maps to a 500 response.

##### 2.5.3.10.6.0 Performance

###### 2.5.3.10.6.1 Latency

N/A

### 2.5.4.0.0.0 Data Request

#### 2.5.4.1.0.0 Source Id

application_layer

#### 2.5.4.2.0.0 Target Id

infrastructure_layer

#### 2.5.4.3.0.0 Message

reportRepository.GetReportsForUserAsync(userId, roles)

#### 2.5.4.4.0.0 Sequence Number

4

#### 2.5.4.5.0.0 Type

üîπ Data Request

#### 2.5.4.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.4.7.0.0 Return Message

List<JobExecutionLog>

#### 2.5.4.8.0.0 Has Return

‚úÖ Yes

#### 2.5.4.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.4.10.0.0 Technical Details

##### 2.5.4.10.1.0 Protocol

In-process

##### 2.5.4.10.2.0 Method

GetReportsForUserAsync

##### 2.5.4.10.3.0 Parameters

- Guid userId
- List<string> roles

##### 2.5.4.10.4.0 Authentication

N/A

##### 2.5.4.10.5.0 Error Handling

EF Core exceptions (e.g., NpgsqlException) are caught and re-thrown as application-specific exceptions.

##### 2.5.4.10.6.0 Performance

###### 2.5.4.10.6.1 Latency

Database query should be optimized with appropriate indexes on JobExecutionLog and permissions tables, targeting < 100ms.

### 2.5.5.0.0.0 State Update

#### 2.5.5.1.0.0 Source Id

presentation_layer_react

#### 2.5.5.2.0.0 Target Id

presentation_layer_react

#### 2.5.5.3.0.0 Message

On API success, update Zustand store with report list and set UI state to 'success'. Component re-renders to display reports.

#### 2.5.5.4.0.0 Sequence Number

5

#### 2.5.5.5.0.0 Type

üîπ State Update

#### 2.5.5.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.5.7.0.0 Return Message



#### 2.5.5.8.0.0 Has Return

‚ùå No

#### 2.5.5.9.0.0 Is Activation

‚ùå No

#### 2.5.5.10.0.0 Technical Details

##### 2.5.5.10.1.0 Protocol

Internal

##### 2.5.5.10.2.0 Method

store.setReports()

##### 2.5.5.10.3.0 Parameters

- ReportViewerItemDto[] data

##### 2.5.5.10.4.0 Authentication

N/A

##### 2.5.5.10.5.0 Error Handling

N/A

##### 2.5.5.10.6.0 Performance

###### 2.5.5.10.6.1 Latency

UI should update within 100ms of receiving data.

### 2.5.6.0.0.0 API Request

#### 2.5.6.1.0.0 Source Id

presentation_layer_react

#### 2.5.6.2.0.0 Target Id

api_web_layer

#### 2.5.6.3.0.0 Message

User filters reports. Debounced API call: GET /api/v1/reports/viewer?search=Sales&status=Succeeded

#### 2.5.6.4.0.0 Sequence Number

6

#### 2.5.6.5.0.0 Type

üîπ API Request

#### 2.5.6.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.6.7.0.0 Return Message

200 OK: Filtered ReportViewerItemDto[]

#### 2.5.6.8.0.0 Has Return

‚úÖ Yes

#### 2.5.6.9.0.0 Is Activation

‚ùå No

#### 2.5.6.10.0.0 Technical Details

##### 2.5.6.10.1.0 Protocol

HTTPS

##### 2.5.6.10.2.0 Method

GET

##### 2.5.6.10.3.0 Parameters

- Query Params: ?search=..., ?status=...
- Headers: { Authorization: 'Bearer <JWT>' }

##### 2.5.6.10.4.0 Authentication

JWT Bearer Token required.

##### 2.5.6.10.5.0 Error Handling

Same as initial fetch.

##### 2.5.6.10.6.0 Performance

###### 2.5.6.10.6.1 Latency

Debounce interval of 300ms to prevent excessive requests.

#### 2.5.6.11.0.0 Nested Interactions

- {'sourceId': 'api_web_layer', 'targetId': 'infrastructure_layer', 'message': 'The request flows through the application layer to the repository, which now executes a parameterized query with WHERE clauses for the search and filter criteria.', 'sequenceNumber': 6.1, 'type': 'Data Request', 'isSynchronous': True, 'returnMessage': 'Filtered List<JobExecutionLog>', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'In-process', 'method': 'GetReportsForUserAsync (with filter parameters)', 'parameters': [], 'authentication': 'N/A', 'errorHandling': 'N/A', 'performance': {'latency': 'Query performance must be maintained with filters; indexes on searched columns are critical.'}}}

### 2.5.7.0.0.0 API Request

#### 2.5.7.1.0.0 Source Id

presentation_layer_react

#### 2.5.7.2.0.0 Target Id

api_web_layer

#### 2.5.7.3.0.0 Message

User clicks download for a report. GET /api/v1/jobs/{jobId}/result

#### 2.5.7.4.0.0 Sequence Number

7

#### 2.5.7.5.0.0 Type

üîπ API Request

#### 2.5.7.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.7.7.0.0 Return Message

200 OK: File Stream | 403 Forbidden | 404 Not Found

#### 2.5.7.8.0.0 Has Return

‚úÖ Yes

#### 2.5.7.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.7.10.0.0 Technical Details

##### 2.5.7.10.1.0 Protocol

HTTPS

##### 2.5.7.10.2.0 Method

GET

##### 2.5.7.10.3.0 Parameters

- Headers: { Authorization: 'Bearer <JWT>' }

##### 2.5.7.10.4.0 Authentication

JWT Bearer Token required.

##### 2.5.7.10.5.0 Error Handling

UI handles 403 by showing 'Access Denied' toast. UI handles 404 by showing 'File Not Found' toast.

##### 2.5.7.10.6.0 Performance

###### 2.5.7.10.6.1 Latency

Time to first byte should be fast; this is a streaming operation.

### 2.5.8.0.0.0 Method Call

#### 2.5.8.1.0.0 Source Id

api_web_layer

#### 2.5.8.2.0.0 Target Id

application_layer

#### 2.5.8.3.0.0 Message

jobsController.GetResult(jobId, userContext)

#### 2.5.8.4.0.0 Sequence Number

8

#### 2.5.8.5.0.0 Type

üîπ Method Call

#### 2.5.8.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.8.7.0.0 Return Message

FileStreamResult

#### 2.5.8.8.0.0 Has Return

‚úÖ Yes

#### 2.5.8.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.8.10.0.0 Technical Details

##### 2.5.8.10.1.0 Protocol

In-process

##### 2.5.8.10.2.0 Method

GetReportArtifactStreamAsync(jobId, userId)

##### 2.5.8.10.3.0 Parameters

- Guid jobId
- Guid userId

##### 2.5.8.10.4.0 Authentication

N/A

##### 2.5.8.10.5.0 Error Handling

Throws `ForbiddenAccessException` or `NotFoundException`.

##### 2.5.8.10.6.0 Performance

###### 2.5.8.10.6.1 Latency

N/A

### 2.5.9.0.0.0 Authorization Check

#### 2.5.9.1.0.0 Source Id

application_layer

#### 2.5.9.2.0.0 Target Id

infrastructure_layer

#### 2.5.9.3.0.0 Message

First, check permissions: reportRepository.CanUserAccessJobAsync(userId, jobId)

#### 2.5.9.4.0.0 Sequence Number

9

#### 2.5.9.5.0.0 Type

üîπ Authorization Check

#### 2.5.9.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.9.7.0.0 Return Message

bool

#### 2.5.9.8.0.0 Has Return

‚úÖ Yes

#### 2.5.9.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.9.10.0.0 Technical Details

##### 2.5.9.10.1.0 Protocol

In-process

##### 2.5.9.10.2.0 Method

CanUserAccessJobAsync

##### 2.5.9.10.3.0 Parameters

- Guid userId
- Guid jobId

##### 2.5.9.10.4.0 Authentication

N/A

##### 2.5.9.10.5.0 Error Handling

If returns false, application service throws `ForbiddenAccessException`.

##### 2.5.9.10.6.0 Performance

###### 2.5.9.10.6.1 Latency

Very fast query, < 20ms.

### 2.5.10.0.0.0 Data Request

#### 2.5.10.1.0.0 Source Id

application_layer

#### 2.5.10.2.0.0 Target Id

infrastructure_layer

#### 2.5.10.3.0.0 Message

If authorized, fetch artifact: artifactStorage.GetArtifactStreamAsync(jobId)

#### 2.5.10.4.0.0 Sequence Number

10

#### 2.5.10.5.0.0 Type

üîπ Data Request

#### 2.5.10.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.10.7.0.0 Return Message

Stream (or null if not found)

#### 2.5.10.8.0.0 Has Return

‚úÖ Yes

#### 2.5.10.9.0.0 Is Activation

‚úÖ Yes

#### 2.5.10.10.0.0 Technical Details

##### 2.5.10.10.1.0 Protocol

File System/Cloud Storage SDK

##### 2.5.10.10.2.0 Method

GetArtifactStreamAsync

##### 2.5.10.10.3.0 Parameters

- Guid jobId

##### 2.5.10.10.4.0 Authentication

Handled by underlying storage provider (e.g., IAM roles for S3).

##### 2.5.10.10.5.0 Error Handling

If stream is null, application service throws `NotFoundException`.

##### 2.5.10.10.6.0 Performance

###### 2.5.10.10.6.1 Latency

Dependent on storage backend performance.

### 2.5.11.0.0.0 API Response

#### 2.5.11.1.0.0 Source Id

api_web_layer

#### 2.5.11.2.0.0 Target Id

presentation_layer_react

#### 2.5.11.3.0.0 Message

Return FileStreamResult. Sets 'Content-Disposition' and 'Content-Type' headers to trigger browser download.

#### 2.5.11.4.0.0 Sequence Number

11

#### 2.5.11.5.0.0 Type

üîπ API Response

#### 2.5.11.6.0.0 Is Synchronous

‚úÖ Yes

#### 2.5.11.7.0.0 Return Message

HTTP 200 with file stream body

#### 2.5.11.8.0.0 Has Return

‚úÖ Yes

#### 2.5.11.9.0.0 Is Activation

‚ùå No

#### 2.5.11.10.0.0 Technical Details

##### 2.5.11.10.1.0 Protocol

HTTPS

##### 2.5.11.10.2.0 Method

N/A

##### 2.5.11.10.3.0 Parameters

- Headers: { Content-Type: 'application/pdf', Content-Disposition: 'attachment; filename="...' }

##### 2.5.11.10.4.0 Authentication

N/A

##### 2.5.11.10.5.0 Error Handling

N/A

##### 2.5.11.10.6.0 Performance

###### 2.5.11.10.6.1 Latency

N/A

## 2.6.0.0.0.0 Notes

### 2.6.1.0.0.0 Content

#### 2.6.1.1.0.0 Content

State management on the client is crucial. The UI must handle 'idle', 'loading', 'success', and 'error' states for fetching the report list to provide clear user feedback.

#### 2.6.1.2.0.0 Position

top-left

#### 2.6.1.3.0.0 Participant Id

presentation_layer_react

#### 2.6.1.4.0.0 Sequence Number

1

### 2.6.2.0.0.0 Content

#### 2.6.2.1.0.0 Content

All data access from the Infrastructure Layer that is based on user identity MUST include tenancy or RBAC checks within the database query itself to prevent data leakage. Filtering should not happen in memory.

#### 2.6.2.2.0.0 Position

bottom-right

#### 2.6.2.3.0.0 Participant Id

infrastructure_layer

#### 2.6.2.4.0.0 Sequence Number

4

### 2.6.3.0.0.0 Content

#### 2.6.3.1.0.0 Content

The secure download endpoint (`/api/v1/jobs/{jobId}/result`) MUST re-validate the user's permission for that specific `jobId` on every request. Relying only on the initial list load is a security risk.

#### 2.6.3.2.0.0 Position

middle-right

#### 2.6.3.3.0.0 Participant Id

application_layer

#### 2.6.3.4.0.0 Sequence Number

9

## 2.7.0.0.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | All API endpoints must be protected by JWT authent... |
| Performance Targets | Initial report list load API P95 latency should be... |
| Error Handling Strategy | The React client must gracefully handle API errors... |
| Testing Considerations | Frontend tests should cover loading and error stat... |
| Monitoring Requirements | Monitor the latency and error rate of `/api/v1/rep... |
| Deployment Considerations | The frontend is a static build deployed to a CDN. ... |


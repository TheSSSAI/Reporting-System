# 1 Overview

## 1.1 Diagram Id

SEQ-FF-003

## 1.2 Name

Administrator Previews a Data Transformation Script

## 1.3 Description

In the Control Panel, an Administrator is editing a JavaScript transformation script. They provide sample JSON data in an input pane and click a 'Preview' button. The system executes the script against the sample data in the secure Jint sandbox and displays the transformed JSON output or any script errors in an output pane.

## 1.4 Type

ðŸ”¹ FeatureFlow

## 1.5 Purpose

To allow administrators to safely and quickly iterate on data transformation logic without running a full report job.

## 1.6 Complexity

Medium

## 1.7 Priority

ðŸŸ¡ Medium

## 1.8 Frequency

OnDemand

## 1.9 Participants

- presentationlayerreact
- apiweblayer
- application_layer
- infrastructure_layer

## 1.10 Key Interactions

- Admin writes a script and provides sample JSON in the React UI.
- Admin clicks 'Preview'.
- The UI sends the script content and sample data to a dedicated preview API endpoint.
- Application Layer receives the request and invokes the JintTransformationEngine.
- The Jint engine executes the script with the provided data, subject to a short timeout (e.g., 15 seconds).
- The transformed JSON result or a structured error object is returned.
- The UI displays the result in the output pane.

## 1.11 Triggers

- Administrator clicks the 'Preview' button in the transformation editor.

## 1.12 Outcomes

- The administrator can see the result of their script execution instantly.
- Syntax and runtime errors in the script are clearly displayed.

## 1.13 Business Rules

- The preview function has a 15-second timeout to prevent freezing the UI.
- The execution uses the same secure sandbox as a real report job.

## 1.14 Error Scenarios

- The script contains a syntax error.
- The script enters an infinite loop and hits the timeout.
- The sample data is not valid JSON.

## 1.15 Integration Points

*No items available*

# 2.0 Details

## 2.1 Diagram Id

SEQ-FF-003

## 2.2 Name

Implementation-Ready Sequence: Administrator Previews Data Transformation Script

## 2.3 Description

This sequence details the technical interactions for an administrator previewing a JavaScript transformation script from the Control Panel. The React frontend sends the script and sample data to a secure ASP.NET Core API endpoint. The backend uses a sandboxed Jint engine with a strict timeout to execute the script, returning either the transformed JSON or a structured error. The entire flow adheres to the Clean Architecture principles of the system.

## 2.4 Participants

### 2.4.1 Frontend SPA

#### 2.4.1.1 Repository Id

presentation_layer_react

#### 2.4.1.2 Display Name

React Control Panel

#### 2.4.1.3 Type

ðŸ”¹ Frontend SPA

#### 2.4.1.4 Technology

React 18, TypeScript, Axios

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #61DAFB |
| Stereotype | UI |

### 2.4.2.0 API Controller

#### 2.4.2.1 Repository Id

api_web_layer

#### 2.4.2.2 Display Name

API/Web Layer

#### 2.4.2.3 Type

ðŸ”¹ API Controller

#### 2.4.2.4 Technology

ASP.NET Core 8

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #512BD4 |
| Stereotype | Controller |

### 2.4.3.0 Application Service

#### 2.4.3.1 Repository Id

application_layer

#### 2.4.3.2 Display Name

Application Layer

#### 2.4.3.3 Type

ðŸ”¹ Application Service

#### 2.4.3.4 Technology

.NET 8

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #1E88E5 |
| Stereotype | Service |

### 2.4.4.0 Engine/Repository

#### 2.4.4.1 Repository Id

infrastructure_layer

#### 2.4.4.2 Display Name

Infrastructure Layer

#### 2.4.4.3 Type

ðŸ”¹ Engine/Repository

#### 2.4.4.4 Technology

Jint, Entity Framework Core 8

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #43A047 |
| Stereotype | Infrastructure |

## 2.5.0.0 Interactions

### 2.5.1.0 HTTP Request

#### 2.5.1.1 Source Id

presentation_layer_react

#### 2.5.1.2 Target Id

api_web_layer

#### 2.5.1.3 Message

1. POST /api/v1/transformations/preview

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

ðŸ”¹ HTTP Request

#### 2.5.1.6 Is Synchronous

âœ… Yes

#### 2.5.1.7 Return Message

10. Returns 200 OK with transformed JSON or 400 Bad Request with structured error.

#### 2.5.1.8 Has Return

âœ… Yes

#### 2.5.1.9 Is Activation

âœ… Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | HTTPS |
| Method | POST |
| Parameters | RequestBody: { scriptContent: string, sampleJson: ... |
| Authentication | Authorization: Bearer <JWT> |
| Error Handling | Client-side logic handles 400, 401, 408, 500 statu... |
| Performance | Request should complete within the 15s server-side... |

### 2.5.2.0 Security Check

#### 2.5.2.1 Source Id

api_web_layer

#### 2.5.2.2 Target Id

api_web_layer

#### 2.5.2.3 Message

2. Middleware validates JWT and authorizes user role ('Administrator').

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

ðŸ”¹ Security Check

#### 2.5.2.6 Is Synchronous

âœ… Yes

#### 2.5.2.7 Return Message



#### 2.5.2.8 Has Return

âŒ No

#### 2.5.2.9 Is Activation

âŒ No

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | Authentication & Authorization Middleware |
| Parameters | HttpContext |
| Authentication | Validates token signature, expiry, and issuer. Che... |
| Error Handling | Returns 401 Unauthorized or 403 Forbidden if check... |
| Performance | Sub-millisecond latency; relies on cached token va... |

### 2.5.3.0 Method Call

#### 2.5.3.1 Source Id

api_web_layer

#### 2.5.3.2 Target Id

application_layer

#### 2.5.3.3 Message

3. transformationService.ExecutePreviewAsync(requestDto, cancellationToken)

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

ðŸ”¹ Method Call

#### 2.5.3.6 Is Synchronous

âœ… Yes

#### 2.5.3.7 Return Message

9. Returns TransformationPreviewResult object.

#### 2.5.3.8 Has Return

âœ… Yes

#### 2.5.3.9 Is Activation

âœ… Yes

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | ExecutePreviewAsync |
| Parameters | requestDto: Contains script and sample JSON. cance... |
| Authentication | N/A (Handled by middleware) |
| Error Handling | Wraps call in try-catch. Maps service-layer except... |
| Performance | Orchestrates the call and adheres to the 15s Cance... |

### 2.5.4.0 Method Call (Fire-and-forget)

#### 2.5.4.1 Source Id

application_layer

#### 2.5.4.2 Target Id

infrastructure_layer

#### 2.5.4.3 Message

4. auditLogger.LogAuditEventAsync(auditEvent)

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

ðŸ”¹ Method Call (Fire-and-forget)

#### 2.5.4.6 Is Synchronous

âŒ No

#### 2.5.4.7 Return Message



#### 2.5.4.8 Has Return

âŒ No

#### 2.5.4.9 Is Activation

âŒ No

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | LogAuditEventAsync |
| Parameters | auditEvent: { UserId, Action: 'PreviewScript', Tim... |
| Authentication | N/A |
| Error Handling | Handled asynchronously. Errors are logged internal... |
| Performance | Executed out-of-band to not add latency to the use... |

### 2.5.5.0 Method Call (via Interface)

#### 2.5.5.1 Source Id

application_layer

#### 2.5.5.2 Target Id

infrastructure_layer

#### 2.5.5.3 Message

5. transformationEngine.ExecuteAsync(script, data, constraints, token)

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

ðŸ”¹ Method Call (via Interface)

#### 2.5.5.6 Is Synchronous

âœ… Yes

#### 2.5.5.7 Return Message

8. Returns TransformationResult with output or error details.

#### 2.5.5.8 Has Return

âœ… Yes

#### 2.5.5.9 Is Activation

âœ… Yes

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-process |
| Method | ExecuteAsync |
| Parameters | script: string, data: string, constraints: { Timeo... |
| Authentication | N/A |
| Error Handling | Implementation must be robust, catching all Jint e... |
| Performance | The core performance-critical operation, constrain... |

### 2.5.6.0 Internal Processing

#### 2.5.6.1 Source Id

infrastructure_layer

#### 2.5.6.2 Target Id

infrastructure_layer

#### 2.5.6.3 Message

6. Executes script in secure Jint sandbox.

#### 2.5.6.4 Sequence Number

6

#### 2.5.6.5 Type

ðŸ”¹ Internal Processing

#### 2.5.6.6 Is Synchronous

âœ… Yes

#### 2.5.6.7 Return Message

7. Captures result or exception.

#### 2.5.6.8 Has Return

âœ… Yes

#### 2.5.6.9 Is Activation

âŒ No

#### 2.5.6.10 Nested Interactions

*No items available*

#### 2.5.6.11 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal |
| Method | Jint.Engine.Execute() |
| Parameters | Input data is passed as a variable to the script c... |
| Authentication | N/A |
| Error Handling | Catches Jint.Runtime.JavaScriptException for scrip... |
| Performance | Monitored and constrained by the sandbox limits pa... |

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content



```
Jint Sandbox Configuration:
- new Engine(options => {
  options.TimeoutInterval(constraints.Timeout);
  options.MemoryLimit(constraints.MemoryLimit);
  options.MaxStatements(constraints.MaxStatements);
  options.AllowClr(false); // CRITICAL: Prevents access to .NET framework
});
```

#### 2.6.1.2 Position

right

#### 2.6.1.3 Participant Id

infrastructure_layer

#### 2.6.1.4 Sequence Number

6

### 2.6.2.0 Content

#### 2.6.2.1 Content

A CancellationTokenSource with a 15-second delay is created here and its token is passed down through all subsequent calls to enforce the timeout requirement.

#### 2.6.2.2 Position

left

#### 2.6.2.3 Participant Id

api_web_layer

#### 2.6.2.4 Sequence Number

3

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | 1. JWT Authentication and Authorization: The API e... |
| Performance Targets | 1. P99 Latency: The API endpoint should respond in... |
| Error Handling Strategy | 1. Invalid Input: If 'sampleJson' is not valid JSO... |
| Testing Considerations | 1. Unit Tests: The `JintTransformationEngine` must... |
| Monitoring Requirements | 1. Prometheus Metrics: Instrument the flow with a ... |
| Deployment Considerations | The feature should be deployable as part of the ma... |


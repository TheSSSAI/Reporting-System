# 1 Overview

## 1.1 Diagram Id

SEQ-BP-001

## 1.2 Name

Scheduled Report Generation and Delivery

## 1.3 Description

The Quartz.NET scheduler triggers a pre-configured report job. The system executes the full data pipeline: ingesting data from the source via a connector, standardizing it to JSON, applying a JavaScript transformation with Jint if configured, generating the report artifact (e.g., PDF via Puppeteer Sharp), and delivering it to destinations (e.g., email, S3) using resiliency policies from Polly.

## 1.4 Type

üîπ BusinessProcess

## 1.5 Purpose

To automate the core business function of generating and delivering reports based on a predefined schedule.

## 1.6 Complexity

Critical

## 1.7 Priority

üö® Critical

## 1.8 Frequency

Daily

## 1.9 Participants

- infrastructure_layer
- application_layer

## 1.10 Key Interactions

- Quartz.NET scheduler service triggers the configured job.
- Application Layer retrieves the ReportConfiguration from the database.
- Infrastructure Layer's specific connector implementation (e.g., for SQL Server) ingests data from the external source.
- Data is converted into a standardized JSON format for internal processing.
- Application Layer invokes the Infrastructure Layer's JintTransformationEngine to execute the transformation script (if configured).
- Application Layer invokes the Infrastructure Layer's generation components (Handlebars.Net/Puppeteer Sharp) to produce the report artifact or serializes data directly (JSON/CSV).
- Infrastructure Layer's delivery clients (e.g., S3 client, SMTP client), wrapped in Polly resiliency policies, deliver the artifact.
- The JobExecutionLog is created at the start and updated with the final status (Succeeded/Failed) and detailed logs at the end.

## 1.11 Triggers

- CRON schedule is met for an active report job.

## 1.12 Outcomes

- A report artifact is generated and stored temporarily.
- The artifact is successfully delivered to all configured destinations.
- A detailed log of the entire job execution is created and persisted.

## 1.13 Business Rules

- A job is marked as 'Failed' if any single step (ingestion, transformation, generation, or any delivery) fails after retries.
- The system will retry connections to unavailable data sources and delivery endpoints based on the configured Polly resiliency policy.

## 1.14 Error Scenarios

- Data source is unavailable after all retries.
- Transformation script throws an unhandled exception.
- PDF generation engine (headless Chromium) crashes.
- A delivery endpoint is unreachable after all retries.

## 1.15 Integration Points

- Data Sources (DBs, OPC UA, Filesystems)
- Delivery Destinations (Amazon S3, Azure Blob, SMTP, FTP/SFTP)

# 2.0 Details

## 2.1 Diagram Id

SEQ-BP-001

## 2.2 Name

Scheduled Report Generation and Delivery Pipeline

## 2.3 Description

A comprehensive technical sequence detailing the automated business process for report generation. The sequence is initiated by a Quartz.NET scheduler, which triggers a job in the Application Service Host. The host orchestrates a multi-step pipeline involving the Infrastructure Layer for data ingestion, transformation, report artifact generation, and delivery to external systems. The process includes robust error handling and resiliency patterns via Polly and maintains a stateful execution log for auditing and monitoring.

## 2.4 Participants

### 2.4.1 External Scheduler

#### 2.4.1.1 Repository Id

external-quartz-scheduler

#### 2.4.1.2 Display Name

Quartz.NET Scheduler

#### 2.4.1.3 Type

üîπ External Scheduler

#### 2.4.1.4 Technology

Quartz.NET 3.x

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #90A4AE |
| Stereotype | <<External>> |

### 2.4.2.0 Application Service

#### 2.4.2.1 Repository Id

REPO-08-SERVICE-HOST

#### 2.4.2.2 Display Name

Application Service Host

#### 2.4.2.3 Type

üîπ Application Service

#### 2.4.2.4 Technology

C# on .NET 8

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #42A5F5 |
| Stereotype | <<Orchestrator>> |

### 2.4.3.0 Infrastructure Services

#### 2.4.3.1 Repository Id

REPO-05-INFRASTRUCTURE

#### 2.4.3.2 Display Name

Infrastructure Layer

#### 2.4.3.3 Type

üîπ Infrastructure Services

#### 2.4.3.4 Technology

EF Core 8, Jint, Polly, Puppeteer Sharp

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #FFEE58 |
| Stereotype | <<Implementation>> |

### 2.4.4.0 External Dependency

#### 2.4.4.1 Repository Id

external-systems

#### 2.4.4.2 Display Name

External Systems

#### 2.4.4.3 Type

üîπ External Dependency

#### 2.4.4.4 Technology

SQL, S3, SMTP, OPC UA

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #BDBDBD |
| Stereotype | <<Data Source/Destination>> |

## 2.5.0.0 Interactions

### 2.5.1.0 Method Call

#### 2.5.1.1 Source Id

external-quartz-scheduler

#### 2.5.1.2 Target Id

REPO-08-SERVICE-HOST

#### 2.5.1.3 Message

ExecuteJob(IJobExecutionContext context)

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Method Call

#### 2.5.1.6 Is Synchronous

‚úÖ Yes

#### 2.5.1.7 Return Message

Task

#### 2.5.1.8 Has Return

‚úÖ Yes

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process |
| Method | IJob.Execute |
| Parameters | context contains JobKey, Trigger, MergedJobDataMap... |
| Authentication | N/A |
| Error Handling | Quartz.NET handles exceptions and marks the trigge... |
| Performance | Sub-millisecond invocation. |

### 2.5.2.0 Database Write

#### 2.5.2.1 Source Id

REPO-08-SERVICE-HOST

#### 2.5.2.2 Target Id

REPO-05-INFRASTRUCTURE

#### 2.5.2.3 Message

CreateJobExecutionLogAsync(reportConfigId, 'Queued')

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ Database Write

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

Task<JobExecutionLog>

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚ùå No

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process (EF Core) |
| Method | IJobExecutionLogRepository.AddAsync |
| Parameters | ReportConfigurationId, initial status enum |
| Authentication | N/A |
| Error Handling | Throws InvalidOperationException if config ID is i... |
| Performance | P99 < 50ms |

### 2.5.3.0 Database Read

#### 2.5.3.1 Source Id

REPO-08-SERVICE-HOST

#### 2.5.3.2 Target Id

REPO-05-INFRASTRUCTURE

#### 2.5.3.3 Message

GetReportConfigurationByIdAsync(reportConfigId)

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Database Read

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

Task<ReportConfiguration>

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚ùå No

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process (EF Core) |
| Method | IReportConfigurationRepository.GetByIdAsync |
| Parameters | Guid reportConfigId |
| Authentication | N/A |
| Error Handling | Throws EntityNotFoundException if config is delete... |
| Performance | P99 < 50ms |

### 2.5.4.0 Method Call

#### 2.5.4.1 Source Id

REPO-08-SERVICE-HOST

#### 2.5.4.2 Target Id

REPO-05-INFRASTRUCTURE

#### 2.5.4.3 Message

FetchDataAsync(connectorConfig)

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Method Call

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

Task<JsonNode>

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚úÖ Yes

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process |
| Method | IConnector.FetchDataAsync |
| Parameters | ConnectorConfiguration object |
| Authentication | N/A |
| Error Handling | Catches exceptions from specific connector impleme... |
| Performance | Highly variable, depends on external source. |

#### 2.5.4.11 Nested Interactions

- {'sourceId': 'REPO-05-INFRASTRUCTURE', 'targetId': 'external-systems', 'message': '[Polly Retry] Execute SQL Query / Read File / Call OPC UA', 'sequenceNumber': 4.1, 'type': 'API Call', 'isSynchronous': True, 'returnMessage': 'Raw Data (Stream, DataSet)', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'TDS, SMB, OPC UA Binary', 'method': 'Varies by connector', 'parameters': 'Connection string, query, file path', 'authentication': 'DB Credentials, API Keys, Service Account', 'errorHandling': 'Wrapped in a Polly Retry Policy (3 retries, exponential backoff) to handle transient network or service availability issues.', 'performance': 'Governed by external system latency and network throughput.'}}

### 2.5.5.0 Method Call

#### 2.5.5.1 Source Id

REPO-08-SERVICE-HOST

#### 2.5.5.2 Target Id

REPO-05-INFRASTRUCTURE

#### 2.5.5.3 Message

ExecuteTransformationAsync(script, jsonData)

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Method Call

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message

Task<JsonNode>

#### 2.5.5.8 Has Return

‚úÖ Yes

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process |
| Method | ITransformationEngine.ExecuteAsync |
| Parameters | string scriptContent, JsonNode data |
| Authentication | N/A |
| Error Handling | Catches Jint.Runtime.JavaScriptException or Timeou... |
| Performance | Governed by script complexity. P95 < 10 seconds fo... |

### 2.5.6.0 Method Call

#### 2.5.6.1 Source Id

REPO-08-SERVICE-HOST

#### 2.5.6.2 Target Id

REPO-05-INFRASTRUCTURE

#### 2.5.6.3 Message

GenerateReportAsync(template, data, format)

#### 2.5.6.4 Sequence Number

6

#### 2.5.6.5 Type

üîπ Method Call

#### 2.5.6.6 Is Synchronous

‚úÖ Yes

#### 2.5.6.7 Return Message

Task<Stream>

#### 2.5.6.8 Has Return

‚úÖ Yes

#### 2.5.6.9 Is Activation

‚ùå No

#### 2.5.6.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process |
| Method | IReportGenerator.GenerateAsync |
| Parameters | Handlebars template, JsonNode data, OutputFormat e... |
| Authentication | N/A |
| Error Handling | Catches exceptions from Handlebars.Net templating ... |
| Performance | PDF generation is resource-intensive. P95 < 30 sec... |

### 2.5.7.0 Method Call

#### 2.5.7.1 Source Id

REPO-08-SERVICE-HOST

#### 2.5.7.2 Target Id

REPO-05-INFRASTRUCTURE

#### 2.5.7.3 Message

[Loop] DeliverReportAsync(reportArtifact, deliveryConfig)

#### 2.5.7.4 Sequence Number

7

#### 2.5.7.5 Type

üîπ Method Call

#### 2.5.7.6 Is Synchronous

‚úÖ Yes

#### 2.5.7.7 Return Message

Task<DeliveryResult>

#### 2.5.7.8 Has Return

‚úÖ Yes

#### 2.5.7.9 Is Activation

‚úÖ Yes

#### 2.5.7.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process |
| Method | IDeliveryClient.DeliverAsync |
| Parameters | Stream artifact, DeliveryConfiguration object |
| Authentication | N/A |
| Error Handling | Each delivery is independent. A single delivery fa... |
| Performance | Depends on external destination. |

#### 2.5.7.11 Nested Interactions

- {'sourceId': 'REPO-05-INFRASTRUCTURE', 'targetId': 'external-systems', 'message': '[Polly Circuit Breaker] S3.PutObject / SMTPS.Send / SFTP.Upload', 'sequenceNumber': 7.1, 'type': 'API Call', 'isSynchronous': True, 'returnMessage': 'Delivery Confirmation', 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'HTTPS, SMTPS, SFTP', 'method': 'Varies by client', 'parameters': 'Endpoint, credentials, payload', 'authentication': 'IAM Role/API Keys, SMTP Credentials', 'errorHandling': 'Wrapped in a Polly Circuit Breaker policy to prevent hammering a failing service. Breaks for 60s after 5 consecutive failures.', 'performance': 'Governed by destination service latency and network bandwidth.'}}

### 2.5.8.0 Database Write

#### 2.5.8.1 Source Id

REPO-08-SERVICE-HOST

#### 2.5.8.2 Target Id

REPO-05-INFRASTRUCTURE

#### 2.5.8.3 Message

UpdateJobExecutionLogAsync(logId, 'Succeeded', details)

#### 2.5.8.4 Sequence Number

8

#### 2.5.8.5 Type

üîπ Database Write

#### 2.5.8.6 Is Synchronous

‚úÖ Yes

#### 2.5.8.7 Return Message

Task

#### 2.5.8.8 Has Return

‚úÖ Yes

#### 2.5.8.9 Is Activation

‚ùå No

#### 2.5.8.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process (EF Core) |
| Method | IJobExecutionLogRepository.UpdateAsync |
| Parameters | Guid logId, final status enum, execution details |
| Authentication | N/A |
| Error Handling | Critical failure if this fails; will be logged to ... |
| Performance | P99 < 50ms |

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

ALT: Failure Flow. If any step from 4 to 7 fails, the orchestrator catches the exception, and the sequence jumps directly to step 8, but with a status of 'Failed' and detailed error information.

#### 2.6.1.2 Position

bottom

#### 2.6.1.3 Participant Id

REPO-08-SERVICE-HOST

#### 2.6.1.4 Sequence Number

8

### 2.6.2.0 Content

#### 2.6.2.1 Content

Step 5 (Transformation) is conditional. It is skipped if the ReportConfiguration does not have an associated TransformationScript.

#### 2.6.2.2 Position

right

#### 2.6.2.3 Participant Id

REPO-08-SERVICE-HOST

#### 2.6.2.4 Sequence Number

5

### 2.6.3.0 Content

#### 2.6.3.1 Content

The JobExecutionLog acts as the persistent state record for this business process, fulfilling audit and monitoring requirements.

#### 2.6.3.2 Position

bottom

#### 2.6.3.3 Participant Id

REPO-05-INFRASTRUCTURE

#### 2.6.3.4 Sequence Number

2

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | Credentials for external data sources and delivery... |
| Performance Targets | The end-to-end process for a standard report (10k ... |
| Error Handling Strategy | The Application Service Host acts as a Saga orches... |
| Testing Considerations | A suite of integration tests is required to valida... |
| Monitoring Requirements | The primary business KPI is the report job success... |
| Deployment Considerations | The application is deployed as a single Windows Se... |


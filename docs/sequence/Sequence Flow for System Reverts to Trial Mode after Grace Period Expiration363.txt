# 1 Overview

## 1.1 Diagram Id

SEQ-FF-001

## 1.2 Name

System Reverts to Trial Mode after Grace Period Expiration

## 1.3 Description

The system is in a 7-day grace period due to a failed license validation. A daily background job checks the license status and determines that the grace period has expired without a successful re-validation. The system automatically transitions its internal state from 'Grace Period' back to 'Trial Mode', re-imposing all functional limitations.

## 1.4 Type

üîπ FeatureFlow

## 1.5 Purpose

To enforce licensing terms by automatically restricting functionality after a license has been invalid for a specified period.

## 1.6 Complexity

Medium

## 1.7 Priority

üî¥ High

## 1.8 Frequency

Daily

## 1.9 Participants

- application_layer

## 1.10 Key Interactions

- A daily background job (managed by Quartz.NET) executes to check system states.
- The job retrieves the current license state and finds it is 'Grace Period'.
- It compares the current date with the stored grace period start date.
- If the difference is greater than 7 days, the job updates the system's state to 'Trial Mode'.
- The application now enforces trial mode limitations on subsequent operations (e.g., creating new schedules, running jobs).

## 1.11 Triggers

- A daily background check runs while the system is in its grace period.

## 1.12 Outcomes

- The system reverts to a functionally limited Trial Mode.
- Administrators will see a persistent 'Trial Mode' indicator when they next log in to the UI.
- Newly generated reports will contain a 'Trial Version' watermark.

## 1.13 Business Rules

- The grace period is exactly 7 days.
- Trial mode limitations include a watermark, a maximum of 3 active schedules, a maximum of 3 total connectors, and disabled custom connectors.

## 1.14 Error Scenarios

*No items available*

## 1.15 Integration Points

*No items available*

# 2.0 Details

## 2.1 Diagram Id

SEQ-FF-001

## 2.2 Name

Implementation: System Reverts to Trial Mode after Grace Period Expiration

## 2.3 Description

Detailed sequence for the daily background job that checks for an expired license grace period. This diagram shows the interaction between the Quartz.NET scheduler, a dedicated license verification service, the system state repository (EF Core/SQLite), and the audit logging service to enforce the license transition from 'Grace Period' to 'Trial Mode' as per business rule BR-GRACE-01.

## 2.4 Participants

### 2.4.1 Job Scheduler

#### 2.4.1.1 Repository Id

REPO-08-SERVICE-HOST

#### 2.4.1.2 Display Name

Quartz.NET Scheduler

#### 2.4.1.3 Type

üîπ Job Scheduler

#### 2.4.1.4 Technology

Quartz.NET 3.x

#### 2.4.1.5 Order

1

#### 2.4.1.6 Style

| Property | Value |
|----------|-------|
| Shape | actor |
| Color | #C0C0C0 |
| Stereotype | ¬´Infrastructure¬ª |

### 2.4.2.0 Background Job

#### 2.4.2.1 Repository Id

REPO-08-SERVICE-HOST-JOB

#### 2.4.2.2 Display Name

CheckLicenseStatusJob

#### 2.4.2.3 Type

üîπ Background Job

#### 2.4.2.4 Technology

.NET 8 IJob Implementation

#### 2.4.2.5 Order

2

#### 2.4.2.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #F8CECC |
| Stereotype | ¬´Application¬ª |

### 2.4.3.0 Application Service

#### 2.4.3.1 Repository Id

REPO-07-APPLICATION

#### 2.4.3.2 Display Name

LicenseService

#### 2.4.3.3 Type

üîπ Application Service

#### 2.4.3.4 Technology

.NET 8 Service

#### 2.4.3.5 Order

3

#### 2.4.3.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #DAE8FC |
| Stereotype | ¬´Application¬ª |

### 2.4.4.0 Data Repository

#### 2.4.4.1 Repository Id

REPO-05-INFRASTRUCTURE

#### 2.4.4.2 Display Name

SystemStateRepository

#### 2.4.4.3 Type

üîπ Data Repository

#### 2.4.4.4 Technology

Entity Framework Core 8 / SQLite

#### 2.4.4.5 Order

4

#### 2.4.4.6 Style

| Property | Value |
|----------|-------|
| Shape | database |
| Color | #D5E8D4 |
| Stereotype | ¬´Infrastructure¬ª |

### 2.4.5.0 Audit Service

#### 2.4.5.1 Repository Id

REPO-05-INFRASTRUCTURE-AUDIT

#### 2.4.5.2 Display Name

AuditService

#### 2.4.5.3 Type

üîπ Audit Service

#### 2.4.5.4 Technology

.NET 8 Service

#### 2.4.5.5 Order

5

#### 2.4.5.6 Style

| Property | Value |
|----------|-------|
| Shape | component |
| Color | #E1D5E7 |
| Stereotype | ¬´Infrastructure¬ª |

## 2.5.0.0 Interactions

### 2.5.1.0 Job Execution

#### 2.5.1.1 Source Id

REPO-08-SERVICE-HOST

#### 2.5.1.2 Target Id

REPO-08-SERVICE-HOST-JOB

#### 2.5.1.3 Message

Execute(IJobExecutionContext context)

#### 2.5.1.4 Sequence Number

1

#### 2.5.1.5 Type

üîπ Job Execution

#### 2.5.1.6 Is Synchronous

‚ùå No

#### 2.5.1.7 Return Message



#### 2.5.1.8 Has Return

‚ùå No

#### 2.5.1.9 Is Activation

‚úÖ Yes

#### 2.5.1.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Quartz.NET Job Execution |
| Method | Execute |
| Parameters | IJobExecutionContext context |
| Authentication | N/A (Internal System Job) |
| Error Handling | Quartz.NET handles job execution failures based on... |
| Performance | Triggered by a daily CRON schedule. |

### 2.5.2.0 Service Call

#### 2.5.2.1 Source Id

REPO-08-SERVICE-HOST-JOB

#### 2.5.2.2 Target Id

REPO-07-APPLICATION

#### 2.5.2.3 Message

Task VerifyGracePeriodExpirationAsync()

#### 2.5.2.4 Sequence Number

2

#### 2.5.2.5 Type

üîπ Service Call

#### 2.5.2.6 Is Synchronous

‚úÖ Yes

#### 2.5.2.7 Return Message

Task

#### 2.5.2.8 Has Return

‚úÖ Yes

#### 2.5.2.9 Is Activation

‚úÖ Yes

#### 2.5.2.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process Method Call |
| Method | VerifyGracePeriodExpirationAsync |
| Parameters | None |
| Authentication | N/A (Internal Call) |
| Error Handling | Exceptions are caught, logged with job context, an... |
| Performance | Expected completion < 1s. |

#### 2.5.2.11 Nested Interactions

- {'sourceId': 'REPO-07-APPLICATION', 'targetId': 'REPO-05-INFRASTRUCTURE', 'message': 'Task<SystemState> GetSystemStateAsync()', 'sequenceNumber': 2.1, 'type': 'Data Retrieval', 'isSynchronous': True, 'returnMessage': "SystemState { Status: 'GracePeriod', GracePeriodStart: '...' }", 'hasReturn': True, 'isActivation': False, 'technicalDetails': {'protocol': 'In-Process (EF Core)', 'method': 'GetSystemStateAsync', 'parameters': 'None', 'authentication': 'N/A (DB connection string)', 'errorHandling': 'EF Core will throw an exception if the SQLite database is unavailable. A Polly retry policy is applied here.', 'performance': 'P99 latency < 50ms. Reads a single configuration row.'}}

### 2.5.3.0 Business Rule Evaluation

#### 2.5.3.1 Source Id

REPO-07-APPLICATION

#### 2.5.3.2 Target Id

REPO-07-APPLICATION

#### 2.5.3.3 Message

Evaluate Grace Period Expiration Logic

#### 2.5.3.4 Sequence Number

3

#### 2.5.3.5 Type

üîπ Business Rule Evaluation

#### 2.5.3.6 Is Synchronous

‚úÖ Yes

#### 2.5.3.7 Return Message

bool: isExpired = true

#### 2.5.3.8 Has Return

‚úÖ Yes

#### 2.5.3.9 Is Activation

‚ùå No

#### 2.5.3.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | Internal Logic |
| Method | if (state.Status == 'GracePeriod' && DateTime.UtcN... |
| Parameters | SystemState object |
| Authentication | N/A |
| Error Handling | N/A |
| Performance | Negligible CPU time. |

### 2.5.4.0 Data Persistence

#### 2.5.4.1 Source Id

REPO-07-APPLICATION

#### 2.5.4.2 Target Id

REPO-05-INFRASTRUCTURE

#### 2.5.4.3 Message

Task UpdateSystemStateAsync(newState)

#### 2.5.4.4 Sequence Number

4

#### 2.5.4.5 Type

üîπ Data Persistence

#### 2.5.4.6 Is Synchronous

‚úÖ Yes

#### 2.5.4.7 Return Message

Task

#### 2.5.4.8 Has Return

‚úÖ Yes

#### 2.5.4.9 Is Activation

‚ùå No

#### 2.5.4.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process (EF Core) |
| Method | UpdateSystemStateAsync |
| Parameters | SystemState { Status: 'TrialMode', ... } |
| Authentication | N/A (DB connection string) |
| Error Handling | Database exceptions (e.g., connection lost, file l... |
| Performance | P99 latency < 100ms. Updates a single row within a... |

### 2.5.5.0 Audit Logging

#### 2.5.5.1 Source Id

REPO-07-APPLICATION

#### 2.5.5.2 Target Id

REPO-05-INFRASTRUCTURE-AUDIT

#### 2.5.5.3 Message

Task LogSystemEventAsync(details)

#### 2.5.5.4 Sequence Number

5

#### 2.5.5.5 Type

üîπ Audit Logging

#### 2.5.5.6 Is Synchronous

‚úÖ Yes

#### 2.5.5.7 Return Message

Task

#### 2.5.5.8 Has Return

‚úÖ Yes

#### 2.5.5.9 Is Activation

‚ùå No

#### 2.5.5.10 Technical Details

| Property | Value |
|----------|-------|
| Protocol | In-Process Method Call |
| Method | LogSystemEventAsync |
| Parameters | AuditEventDetails { ActionType: 'LICENSE_STATE_CHA... |
| Authentication | N/A |
| Error Handling | Failure to write to the audit log is a critical er... |
| Performance | P99 latency < 100ms. Inserts one row into the Audi... |

## 2.6.0.0 Notes

### 2.6.1.0 Content

#### 2.6.1.1 Content

Business Rule: The grace period is hardcoded to exactly 7 days. This should be a configurable setting read from the system state or configuration.

#### 2.6.1.2 Position

bottom-left

#### 2.6.1.3 Participant Id

*Not specified*

#### 2.6.1.4 Sequence Number

3

### 2.6.2.0 Content

#### 2.6.2.1 Content

Impact: Once in 'Trial Mode', the system immediately enforces limitations as defined in the SRS (e.g., report watermarks, schedule limits) on all subsequent user actions and API calls.

#### 2.6.2.2 Position

bottom-right

#### 2.6.2.3 Participant Id

*Not specified*

#### 2.6.2.4 Sequence Number

4

## 2.7.0.0 Implementation Guidance

| Property | Value |
|----------|-------|
| Security Requirements | The job executes with the privileges of the Window... |
| Performance Targets | The entire job execution must complete in under 5 ... |
| Error Handling Strategy | If the database is unavailable during the state ch... |
| Testing Considerations | This feature requires time-sensitive integration t... |
| Monitoring Requirements | A Prometheus counter (`license_state_changes_total... |
| Deployment Considerations | The daily execution schedule for the job (e.g., `0... |

